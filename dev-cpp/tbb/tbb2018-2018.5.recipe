SUMMARY="High level abstract threading library"
DESCRIPTION="Threading Building Blocks (TBB) is a C++ template library \
developed by Intel for parallel programming on multi-core processors. Using \
TBB, a computation is broken down into tasks that can run in parallel. The \
library manages and schedules threads to execute these tasks."
HOMEPAGE="https://www.threadingbuildingblocks.org/"
COPYRIGHT="2005-2018 Intel Corporation"
LICENSE="Apache v2"
REVISION="4"
SOURCE_URI="https://github.com/01org/tbb/archive/${portVersion/./_U}.tar.gz"
CHECKSUM_SHA256="b8dbab5aea2b70cf07844f86fa413e549e099aa3205b6a04059ca92ead93a372"
SOURCE_DIR="oneTBB-2018_U5"
PATCHES="tbb-$portVersion.patchset"

ARCHITECTURES="!x86_gcc2 x86 x86_64"
SECONDARY_ARCHITECTURES="x86"

libtbbVersion="2"
libtbbVersionCompat="$libtbbVersion compat >= ${libtbbVersion%%.*}"
libtbbmallocVersion="2"
libtbbmallocVersionCompat="$libtbbmallocVersion compat >= ${libtbbmallocVersion%%.*}"
libtbbmalloc_proxyVersion="2"
libtbbmalloc_proxyVersionCompat="$libtbbmalloc_proxyVersion compat >= ${libtbbmalloc_proxyVersion%%.*}"

PROVIDES="
	tbb2018$secondaryArchSuffix = $portVersion
	lib:libtbb$secondaryArchSuffix = $libtbbVersionCompat
	lib:libtbbmalloc$secondaryArchSuffix = $libtbbmallocVersionCompat
	lib:libtbbmalloc_proxy$secondaryArchSuffix = $libtbbmalloc_proxyVersionCompat
	"
REQUIRES="
	haiku$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	"
BUILD_PREREQUIRES="
	cmd:find
	cmd:gcc$secondaryArchSuffix
	cmd:grep
	cmd:make
	cmd:sed
	"

defineDebugInfoPackage tbb2018$secondaryArchSuffix \
	$libDir/libtbb.so.$libtbbVersion \
	$libDir/libtbbmalloc.so.$libtbbmallocVersion \
	$libDir/libtbbmalloc_proxy.so.$libtbbmalloc_proxyVersion

BUILD()
{
	make $jobArgs
}

INSTALL()
{
	mkdir -p $libDir

	cd build
	LIB_LOCATION=`find . -maxdepth 1 -type d |grep release`
	cd $LIB_LOCATION

	cp libtbb.so.2 libtbbmalloc.so.2 libtbbmalloc_proxy.so.2 $libDir
}

TEST()
{
	make $jobArgs test
}
